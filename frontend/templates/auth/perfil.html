{% extends "base.html" %}
{% block title %}Mi perfil{% endblock %}

{% block content %}
<div style="max-width:500px;margin:60px auto;padding:0 20px">
  <h1 style="font-size:22px;margin-bottom:24px">ğŸ‘¤ Mi perfil</h1>

  <div class="perfil-avatar" style="display:flex;align-items:center;gap:16px;margin-bottom:28px">
    <div id="previewAvatar" style="width:56px;height:56px;border-radius:50%;background:{{ usuario.avatar_color }};display:flex;align-items:center;justify-content:center;font-size:28px">
      {{ usuario.avatar_emoji }}
    </div>
    <div>
      <strong style="font-size:17px">{{ usuario.nombre_visible() }}</strong><br/>
      <span style="color:#888;font-size:13px">@{{ usuario.username }}</span>
      {% if usuario.es_admin %}<span style="background:#d4a843;color:#000;font-size:10px;padding:2px 6px;border-radius:3px;margin-left:6px">ADMIN</span>{% endif %}
    </div>
  </div>

  <form id="perfilForm">
    <div style="margin-bottom:16px">
      <label style="display:block;margin-bottom:6px;color:#aaa;font-size:13px">Nombre visible</label>
      <input type="text" id="perfDisplayName" value="{{ usuario.nombre_visible() }}" maxlength="80"
        style="width:100%;background:#1a1a1a;border:1px solid #2a2a2a;color:#e0e0e0;padding:10px 14px;border-radius:6px;font-size:14px;box-sizing:border-box"/>
    </div>

    <div style="margin-bottom:16px">
      <label style="display:block;margin-bottom:8px;color:#aaa;font-size:13px">Emoji de avatar</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        {% for em in ["ğŸ­","ğŸ¥","ğŸº","ğŸ¸","ğŸ¶","ğŸ¤","ğŸ‘‘","ğŸ†","ğŸ‰","ğŸ¦","ğŸŒŠ","â­","ğŸª","ğŸ¥³","ğŸ¨"] %}
        <button type="button" class="emoji-btn" data-emoji="{{ em }}"
          style="width:38px;height:38px;border-radius:50%;border:2px solid {% if em == usuario.avatar_emoji %}#d4a843{% else %}transparent{% endif %};background:#1a1a1a;font-size:18px;cursor:pointer">{{ em }}</button>
        {% endfor %}
      </div>
      <input type="hidden" id="perfEmoji" value="{{ usuario.avatar_emoji }}"/>
    </div>

    <div style="margin-bottom:24px">
      <label style="display:block;margin-bottom:6px;color:#aaa;font-size:13px">Color de avatar</label>
      <input type="color" id="perfColor" value="{{ usuario.avatar_color }}"
        style="height:36px;width:80px;border:none;background:none;cursor:pointer;border-radius:4px"/>
    </div>

    <button type="submit" style="background:#d4a843;border:none;color:#000;padding:10px 24px;border-radius:6px;font-weight:700;cursor:pointer;font-size:14px">
      Guardar cambios
    </button>
    <div id="perfilMsg" style="margin-top:12px;font-size:13px"></div>
  </form>

  <div style="margin-top:32px;border-top:1px solid #1a1a1a;padding-top:20px">
    <button id="btnCerrarSesion" style="background:transparent;border:1px solid #333;color:#888;padding:8px 18px;border-radius:6px;cursor:pointer;font-size:13px">
      Cerrar sesiÃ³n
    </button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const previewAvatar = document.getElementById("previewAvatar");

  // Selector de emoji
  document.querySelectorAll(".emoji-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".emoji-btn").forEach(b => b.style.borderColor = "transparent");
      btn.style.borderColor = "#d4a843";
      document.getElementById("perfEmoji").value = btn.dataset.emoji;
      previewAvatar.textContent = btn.dataset.emoji;
    });
  });

  // Color
  document.getElementById("perfColor").addEventListener("input", (e) => {
    previewAvatar.style.background = e.target.value;
  });

  // Guardar
  document.getElementById("perfilForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msg = document.getElementById("perfilMsg");
    try {
      const res = await fetch("/api/auth/perfil", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          display_name: document.getElementById("perfDisplayName").value,
          avatar_emoji: document.getElementById("perfEmoji").value,
          avatar_color: document.getElementById("perfColor").value,
        }),
      });
      const d = await res.json();
      msg.style.color = d.ok ? "#2ecc71" : "#e74c3c";
      msg.textContent = d.ok ? "âœ… Perfil actualizado" : "âŒ " + d.error;
    } catch {
      msg.style.color = "#e74c3c";
      msg.textContent = "âŒ Error de conexiÃ³n";
    }
  });

  // Cerrar sesiÃ³n
  document.getElementById("btnCerrarSesion").addEventListener("click", async () => {
    await fetch("/api/auth/logout", { method: "POST" });
    window.location.href = "/";
  });
});
</script>
{% endblock %}
